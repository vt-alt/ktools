#!/bin/bash

export GREP_COLORS="mt=01;32"
set -eu +f
rroot=/ALT
skip="5.1|c[678].*|fm]1|c9m[12]|c9f1|p[567]|.*armh"

branch=Sisyphus arch=x86_64
branches= arches= packages=
all_arch= lsopts='-ltrd' rpmpeek= lesser='' logs='' dts='' show_task=''
pattern='' query=''
for i; do
	[ "$i" = s ]        && i=Sisyphus
	[ "$i" = sisyphus ] && i=Sisyphus
	if [ -d /ALT/$i ]; then
		branch=$i
		branches+=" $i"
		continue
	fi
	if [ -d /ALT/$branch/files/$i ]; then
		arch=$i
		arches+=" $i"
		continue
	fi
	case "$i" in
		-a|--all-arch*) all_arch=y ;;
		--full-time) lsopts+=" $i" ;;
		-1|--names) lsopts= ;;
		--peek|--rpmpeek) rpmpeek=y; lsopts= ;;
		--less) lesser=y; lsopts= ;;
		--log*) logs=y ;;
		--dts | --ver*) dts=y ;;
		--task) show_task=y ;;
		--ls) query=-l ;;
		--changelog | --configfiles | --conflicts | --docfiles | --dump | --enhances \
		| --filesbypkg | --info | --last | --obsoletes | --provides \
		| --recommends | --requires | --suggests | --supplements | --scripts \
		| --state | --triggers | --triggerscripts | --lastchange | --list \
		| --qf=* | --queryformat=*)
			query=$i ;;
		--ls=* | --list=*) query=-l; pattern=${i#*=} ;;
		--grep=*)
			# --grep= also provides 'no match' message.
			pattern=${i#*=} ;;
		-*) echo "No option $i"; exit 1 ;;
		*) packages+=" $i" ;;
	esac
done

[ -z "${branches-}" ] && branches=$(cd $rroot; ls | grep -E -vwe "$skip" | sort -fu)
: ${flavours:=*}
[ -z "$arches" ] && arches="$arch noarch"

gear_describe()
{
	local tag descr=$(gear --describe 2>&1)
	if [ "$descr" = "gear: specsubst directive requires a tag" ]; then
		tag=$(git describe --abbrev=0 --tags --exclude '*debug*')
		descr=$(gear --describe -t "$tag")
	fi
	set -- $descr
	NAME=$1
	VERSION=$2
	RELEASE=$3
}
if [ -z "$packages" ]; then
	gear_describe
	packages=$NAME
fi

set -f
list=()
for package in $packages; do
	for b in $branches; do
		if [ -n "$all_arch" ]; then
			arches=$(ls $rroot/$b/files/ | grep -v -e - -e SRPMS -e list)
		fi
		for a in $arches; do
			r=$rroot/$b/files/$a/RPMS
			test -d $r || continue
			pat=$r/$package-[0-9]*-alt*.$a.rpm
			set +f
			for i in $pat; do
				test -e $i || continue
				list+=($i)
			done
			set -f
		done
	done
done

select_one() {
	if [ ${#list[@]} -eq 0 ]; then
		echo >&2 "No match!"
		exit 1
	elif [ ${#list[@]} -eq 1 ]; then
		# No choice.
		rpm=$list
	else
		local default=$(ls -1 "${list[@]}" | grep -i -m1 '/sisyphus/')
		rpm=$(gum choose --header='Select one:' --cursor='-> ' --selected="$default" "${list[@]}")
	fi
}

[ ${#list[@]} -gt 0 ] || { echo "No match for '$packages'"; exit 1; }
if [ -n "$rpmpeek" ]; then
	select_one
	prompt=" \[\033[1;36m\]$rpm\[\033[m\]> "
	rpmpeek -n "$rpm" bash --rcfile <(cat ~/.bashrc; echo PS1="\"$prompt\"")
	exit
elif [ -n "$lesser" ]; then
	select_one
	echo >&2 "+ less $rpm"
	echo
	less "$rpm"
	exit
elif [ -n "$logs" ]; then
	select_one
	{
		DISTTAG=$(rpm -qp "$rpm" --qf '%{DISTTAG}')
		IFS=+. read repo task subtask _ <<< "$DISTTAG"
		url="https://git.altlinux.org/tasks/$task/build/$subtask/$arch/log"
		ls -l "$rpm"
		echo >&2 "+ curl $url"
		echo
		curl -sS -L -f "$url"
	} |& less
	exit
elif [ -n "$dts" ]; then
	select_one
	DISTTAG=$(rpm -qp "$rpm" --qf '%{DISTTAG}')
	IFS=+. read repo task subtask _ <<< "$DISTTAG"
	SOURCERPM=$(rpm -qp "$rpm" --qf '%{SOURCERPM}')
	name=${SOURCERPM%-*-*.*.rpm}
	url="http://ftp.altlinux.org/pub/distributions/archive/$repo/index/src/${name:0:1}/$name/d-t-s-evr.list"
	{
		echo >&2 "+ curl $url"
		curl -sS -L -f "$url" | awk 'OFS="\t" {$1=strftime("%Y-%m-%d",$1); print $0}'
	} |& less
	exit
elif [ -n "$show_task" ]; then
	select_one
	DISTTAG=$(rpm -qp "$rpm" --qf '%{DISTTAG}')
	IFS=+. read repo task subtask _ <<< "$DISTTAG"
	(set -x; ssh girar task show --brief "$task")
	exit
elif [ -n "$query" ]; then
	list=( $(printf "%s\n" "${list[@]}" | sort -V) )
	for rpm in "${list[@]}"; do
		prefix=$(basename "$rpm")
		repo=${rpm%%/files/*}
		repo=${repo##*/}
		prefix=$repo/$prefix
		rpm -qp "$query" -- "$rpm" |
		if ! sed "s,^,$prefix: ," | grep --color=auto "$pattern"; then
			echo "$prefix: no match"
		fi
	done
	exit
fi
if [ -t 1 ]; then
	HIGHLIGHT=$'sed -E s!/([Ss]isyphus)/!/\e[1;33m\\1\e[m/!'
else
	HIGHLIGHT=cat
fi
ls $lsopts -- "${list[@]}" \
	| sed -E 's/^\S+\s+\S+\s+\S+\s+\S+//' \
	| $HIGHLIGHT \
	| grep -P --color '^|[^-]+-alt[^-]+(?=\.[^.]+(\.src)?\.s?rpm)'

