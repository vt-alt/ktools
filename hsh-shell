#!/bin/bash
set -efu +o posix

unset rooter opts cmd
setx=
for o do
	shift
	case "$o" in
		--) break ;;
		-x|--verbose) setx='set -x' ;;
		--rooter) rooter=y ;&
		*) opts+=("$o") ;;
	esac
done

# Swap opts and $@
(( $# )) && cmd="$*"
set -- "${opts[@]}"
unset opts

toplevel=$(git rev-parse --show-toplevel 2>/dev/null) && h="$toplevel/.git/bb" || h="$HOME/.cache/hsh-shell"
mkdir -p "$h"
if [[ -v rooter ]]; then
	hist=/root/.bash_history
	opt=(--rooter)
	f=$h/.bash_history--rooter
	if [ -s "$f" ]; then
		hsh-run --rooter -- /usr/bin/test -e "$hist" </dev/null ||
			hsh-run --rooter -- /bin/dd of="$hist" status=none < "$f"
	fi
else
	hist=/usr/src/.bash_history
	opt=()
	f=$h/.bash_history
	if [ -s "$f" ]; then
		hsh-run -- /usr/bin/test -e "$hist" </dev/null ||
			hsh-copy "$f" </dev/null
	fi
fi

unset exports
if [[ -v share_network ]] && [[ -v ALL_PROXY ]]; then
	exports+="ALL_PROXY=${ALL_PROXY@Q}"
	[[ -v NO_PROXY ]] && exports+=" NO_PROXY=${NO_PROXY@Q}"
fi
[[ -v exports ]] && exports="export $exports"

workdir="${TMPDIR-/tmp/.private/$USER}/hasher"
[ -d "$workdir/chroot" ] || workdir="$HOME/hasher"
workdir_sh="$workdir/chroot/.host/shell"
{
	cat > "$workdir_sh" &&
	chmod a+rx "$workdir_sh" &&
	set -- --shell=/.host/shell "$@"
} <<-EOF
	{ cd ~
	  cd $(basename "$PWD")
	  cd ~/RPM/BUILD/*
	  cd ~/RPM/BUILD/*-*
	  cd kernel-source-*; } 2>/dev/null
	${exports-}
	$setx
	exec -a -bash bash ${cmd+-c ${cmd@Q}}
EOF

TERM=${TERM#screen.}
($setx; /usr/bin/hsh-shell "$@")
ret=$?

[ -d "$h" ] || exit "$ret"

rotate() {
	[ -s "${2?}" ] && ln -f "$2" "$2-"
	[ -s "${1?}" ] && mv -f "$1" "$2"
}

hsh-run --no-wait-lock "${opt[@]}" -- /bin/cat "$hist" </dev/null > "$f-new" 2>/dev/null
rotate "$f-new" "$f"

exit "$ret"
