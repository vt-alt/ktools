#!/bin/bash -efu

V() { echo + "$@" >&2; "$@"; }

remote=gitery
unset commit shared
for opt do
	shift
	case "$opt" in
		--commit) commit=y; remote=kernelbot ;;
		--share*) shared=y ;;
		*) set -- "$opt" "$@"; break ;;
	esac
done

br=$(git branch --show-current)
branch=${br#*/}
brflvr=${br%/*}
case $branch in
	sisyphus|p[1-9]*|c[1-9]*) ;;
	*) echo >&2 "Invalid repo $branch"; exit 1 ;;
esac
case $brflvr in
	un-def|std-def|std-pae|std-debug|next) ;;
	*) echo >&2 "Invalid flavour $brflvr"; exit 1 ;;
esac

# Set tags to build.
if [ "$*" ]; then
	set "$@"
else
	set -- $(git tag --points-at @)
fi
V git push $remote $br -f
for tag; do
	flavour=${tag#kernel-image-}
	flavour=${flavour%-*-alt*}

	V git push $remote $tag -f
	task=$(V ssh girar task new $branch)
	V ssh girar task add $task repo kernel-image $tag
	echo PESIGN | \
	V ssh girar task approve $task all
	[ -v shared ] && V ssh girar task share $task enable
	if V ssh girar task add $task kmodules $flavour; then
		msg="-m kmodules"
	else
		msg=
	fi
	V ssh girar task run --fail-late ${commit+--commit} $task $msg
done

